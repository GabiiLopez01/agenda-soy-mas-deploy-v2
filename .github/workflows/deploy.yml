non:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-with-ngrok:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîê Install ngrok and jq
        run: |
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: üöÄ Start React and ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # Configurar ngrok
          echo "üîß Configurando ngrok..."
          ngrok authtoken "$NGROK_AUTH_TOKEN"
          echo "‚úÖ Ngrok autenticado"
          
          # Iniciar servidor de React
          echo "üîÑ Iniciando React en localhost:3000..."
          npm start &
          REACT_PID=$!
          echo "React PID: $REACT_PID"
          
          # Esperar 25 segundos para que React se inicie completamente
          echo "‚è≥ Esperando que React se inicialice (25 segundos)..."
          sleep 25
          
          # Verificar que React est√° corriendo
          echo "üîç Verificando estado de React..."
          if curl -s -f http://localhost:3000 > /dev/null; then
            echo "‚úÖ ‚úÖ React est√° funcionando correctamente en puerto 3000"
          else
            echo "‚ö†Ô∏è React no responde a√∫n, continuando..."
            # Mostrar procesos para debug
            echo "üìä Procesos Node.js:"
            ps aux | grep node || echo "No hay procesos node"
          fi
          
          # Iniciar ngrok en puerto 3000
          echo "üåê Iniciando ngrok en puerto 3000..."
          ngrok http 3000 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "Ngrok PID: $NGROK_PID"
          
          # Esperar 15 segundos para que ngrok se conecte
          echo "‚è≥ Esperando conexi√≥n de ngrok (15 segundos)..."
          sleep 15
          
          # Obtener URL p√∫blica
          echo "üì° Obteniendo URL de ngrok..."
          NGROK_URL=""
          for i in {1..6}; do
            echo "Intento $i/6..."
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty')
            
            if [ -n "$NGROK_URL" ]; then
              echo "‚úÖ URL obtenida: $NGROK_URL"
              break
            fi
            
            if [ $i -lt 6 ]; then
              sleep 5
            fi
          done
          
          if [ -z "$NGROK_URL" ]; then
            echo "‚ùå No se pudo obtener URL de ngrok"
            echo "üìã Logs de ngrok:"
            cat ngrok.log
            echo "üîç Estado de procesos:"
            ps aux | grep ngrok
            exit 1
          fi
          
          # √âXITO - Mostrar informaci√≥n
          echo " "
          echo "üéâ ==========================================="
          echo "üéâ ¬°DEPLOYMENT EXITOSO!"
          echo "üéâ ==========================================="
          echo "üåê URL P√öBLICA: $NGROK_URL"
          echo "üîß Puerto local: 3000"
          echo "‚è∞ T√∫nel activo por 20 minutos"
          echo "üéâ ==========================================="
          echo " "
          
          # Probar la URL p√∫blica
          echo "üß™ Probando conexi√≥n p√∫blica..."
          if curl -s --max-time 10 "$NGROK_URL" > /dev/null; then
            echo "‚úÖ ‚úÖ La aplicaci√≥n responde desde internet!"
          else
            echo "‚ö†Ô∏è  La aplicaci√≥n podr√≠a estar cargando..."
          fi
          
          # Instrucciones para usar
          echo " "
          echo "üì± PARA CONECTAR TU APP M√ìVIL:"
          echo "1. Usa esta URL en tu app: $NGROK_URL"
          echo "2. Reemplaza todas las llamadas a localhost:3000"
          echo "3. Ejemplo: axios.get('$NGROK_URL/api/data')"
          echo " "
          
          # Mantener el servicio activo (20 minutos)
          echo "‚è∞ Manteniendo servicio activo por 20 minutos..."
          sleep 1200
          echo "üõë Tiempo completado - Servicio finalizado"