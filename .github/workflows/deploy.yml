name: Deploy Mobile Backend with Ngrok

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-with-ngrok:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: üì¶ Install dependencies
        run: npm ci
      
      - name: üîê Install ngrok and jq
        run: |
          # Instalar ngrok
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar xzf ngrok-v3-stable-linux-amd64.tgz
          sudo mv ngrok /usr/local/bin/
          
          # Instalar jq para procesar JSON
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Verificar instalaci√≥n
          ngrok version
          jq --version
      
      - name: üöÄ Start server with ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # Configurar ngrok PRIMERO
          echo "üîß Configurando ngrok..."
          ngrok authtoken $NGROK_AUTH_TOKEN
          
          # Iniciar ngrok en background
          echo "üåê Iniciando t√∫nel ngrok..."
          ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "Ngrok PID: $NGROK_PID"
          
          # Esperar a que ngrok est√© listo
          echo "‚è≥ Esperando que ngrok se inicialice..."
          sleep 10
          
          # Iniciar servidor de React en background
          echo "üîÑ Iniciando servidor de React..."
          npm start &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Esperar que el servidor est√© listo
          sleep 15
          
          # Obtener URL p√∫blica de ngrok
          echo "üì° Obteniendo URL de ngrok..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          NGROK_URL=""
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ -z "$NGROK_URL" ]; do
            sleep 5
            echo "Intento $((RETRY_COUNT + 1)) de obtener URL..."
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty')
            if [ -n "$NGROK_URL" ]; then
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          
          if [ -z "$NGROK_URL" ]; then
            echo "‚ùå No se pudo obtener la URL de ngrok despu√©s de $MAX_RETRIES intentos"
            echo "üìã Logs de ngrok:"
            cat ngrok.log
            exit 1
          fi
          
          echo "‚úÖ ==========================================="
          echo "‚úÖ üéâ TU APLICACI√ìN EST√Å EN L√çNEA!"
          echo "‚úÖ URL P√öBLICA: $NGROK_URL"
          echo "‚úÖ ==========================================="
          
          # Probar que la API responde
          echo "üß™ Probando conexi√≥n..."
          curl -s --retry 3 --retry-delay 5 $NGROK_URL || echo "‚ö†Ô∏è  La app podr√≠a estar iniciando..."
          
          # Mantener el job corriendo para testing (30 minutos)
          echo "‚è∞ Manteniendo servicio activo por 30 minutos..."
          sleep 1800
          
          echo "üõë Finalizando servicio..."